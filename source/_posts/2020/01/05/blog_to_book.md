---
title: Markdownで書かれたブログ記事をRe:VIEWを使って「本」にしてみる
thumbnail: /gallery/daily/others/hinastory_cover.jpeg
categories:
  - Tech
  - Boook
tags:
  - ReView
  - Ruby
date: 2020-01-05 07:28:45
---
新年あけましておめでとうございます。お正月といえば**書き初め**ですが自分は字が下手なのでブログを書くことにします。。。

本記事のテーマは**「ブログを本にする」**です。去年の約1年間で38本もの記事を書きましたが、それらを本にしたらどういうことになるかを解説してみたいと思います。

<!-- more -->

## 目次
<!-- toc -->

## はじめに

この記事は「{% elink Re:VIEW https://reviewml.org/ja/ %}」を利用した同人誌作成の初心者向けの記事になります。ブログを印刷可能な本にしてみたい方、Markdownで書かれた記事を電子書籍にしてみたい方向けになります。

## 本作りの下準備

本を作るといってもまだ分からないことだらけなので、調べながら下準備を進めていきます。

### まずは文字数を確認してみる

まずは単純に行数と文字数を数えてみたいと思います。本にする元ネタは本ブログの記事でMarkdownで書かれているのでそれらのファイルを一つのフォルダに集めて、`wc`コマンドで数えます。

{% code lang:bash %}
$ wc -lm *
{% endcode %}

`-l`は行数を表示するオプションで`-m`は文字数（マルチバイトも一文字としてカウント）を表示します。結果は以下のとおりです。

{% code lang:txt %}
 9080 380110 total
{% endcode %}

最初この数字を見たとき目を疑いました。9000行、38万文字も書いた記憶がなかったからです。数え間違いかと思いましたが特に問題もなく・・・[^1]

一般的な新書では400字詰めの原稿用紙で200〜300枚と言われているらしいので8万〜12万文字程度です。つまりこの分量だと3冊も本を出版できてしまいます。しかも自分のブログは画像が多いので画像も含めるとさらに膨らむこと間違いなしです。

[^1]: 一応膨らむ要素としてはリンクや画像のURLがありますが、それを除いても多いのは間違いないです。

### 出版形態を決める

次に出版形態を決めます。といっても大まかに以下の３つの選択肢しかないのでお試しの今回は「同人出版」か「オンデマンド出版」になります。

- 商業出版
  - 出版社を通して出版 (一般書店に流通)
- 自費出版
  - 出版社を通して出版（一般書店には流通、費用は自費）
- 同人出版
  - 出版社を通さず出版（一般書店には流通しない）
- オンデマンド出版
  - {% elink Amazon Kindle ダイレクト・パブリッシング https://kdp.amazon.co.jp/ja_JP/ %}とか
  - ePubで入稿

### 媒体を決める

媒体を決めを簡単に言えば「紙の本」にするか、電子書籍(pdf、ePub、HTML)にするかです。一番楽なのは電子書籍Onlyですが、`「紙の本はロマン」`なので今回は両方への対応を目指します。

### 流通経路を決める

媒体を決めた後はできた本をどのように配布するのかを考えます。販売する場合はさらにお金の回収も考える必要があります。同人誌の場合は「{% elink コミケ https://www.comiket.co.jp/ %}」等の同人誌即売会で販売するのが一般的ですが、技術書の場合は「{% elink 技術書典 https://techbookfest.org/ %}」という選択肢もあります。自分はどれも参加したことはありますが販売したことはありません。。。

インターネットでの販売は「{% elink BOOTH https://booth.pm/ja %}」を使うか、同人誌を扱っているショップに委託して販売するのが一般的なようです。Kindleなら「{% elink AKD https://kdp.amazon.co.jp/ja_JP/ %}」で割と簡単に出版できるようです。

今回はとりあえずどこで頒布するかは決めていないです。とりあえず作ってみてから考えます・・・

### ツールを決める

ようやくここまで決まったら、どのツールを使って制作するのかを考えます。とりあえず以下の３つの要件を満たすものです。

- お手軽
  - これが一番重要
- ローカルのMarkdownファイルを変換できる
  - Web上で変換はファイルが多いのでつらい
- pdf(印刷用)とpdf(電子書籍用)とePubの３つに対応できる

まず、Markdownなら{% elink Pandoc https://pandoc.org/ %}や{% elink GitBook https://www.gitbook.com/ %}があるのですが、印刷用のPDFを作成するのに辛そうな印象があります。オンラインなら{% elink FlightBooks http://flightbooks.pub/ %}や{% elink でんでんマークダウン https://conv.denshochan.com/markdown %}がありますが、これはローカルファイルを変換する今回の趣旨には向いていないです。

ということで、すでにタイトルでネタバレしていますが、基本的にはRe:VIEWを使います。ただし、Re:VIEWはマークダウンの変換には対応してないので{% elink md2review https://github.com/takahashim/md2review %}を用いてMarkdownをRe:VIEW形式に変換します。

### テンプレートを決める

ようやくツールが決まったと思ったらまだ決めることは山程ありました・・・
以下にちょこっと書き出してみましたが、これらを全て適正に作るのは至難の技です。

- 本のサイズ
  - B5が同人誌ではポピュラー。A5も使われる
- レイアウト
  - 横書き
  - 一行の文字数
  - フォント、フォントサイズ
  - 余白
- デザイン
  - 表紙、裏表紙
  - 章と節のデザイン
  - コードの表示
  - 大扉、奥付

さらに紙の印刷では以下のように細かいレイアウトの指定が必要になります。

{% img /gallery/daily/others/book_layout.png  500 %}

 **{% elink Re:VIEW knowledge https://review-knowledge-ja.readthedocs.io/ja/latest/latex/review3-latex.html  %}より引用**

そこでテンプレートを使うことにしました。とりあえず有名なテンプレートは以下の２つです。

- {% elink ReVIEW-Template https://github.com/TechBooster/ReVIEW-Template %}
- {% elink Re:VIEW Starter https://kauplan.org/reviewstarter/ %}

結局はReVIEW-Templateを使うことにしました。決め手はRe:VIEW 4.0に対応していたことです。Re:VIEW 2.0からRe:VIEW 3.0への移行は大変そうなのでとりあえず最新の環境に追随している方を選択しました。

## 実際に本を作ってみる

ここまで調べたり決めたりすることが多くて疲れましたが、ようやくここからが本番です。

### 環境の構築

環境の構築で必要なのは主に以下の３つです。MacでTeX環境を維持するのは面倒だったのでDockerビルドを選択しました。RubyとNode.jsの環境は{% elink anyenv https://anyenv.github.io/ %}を使えば簡単に手に入るのでおすすめです。

- Ruby
  - anyenv経由でrbenvを入れてインストール
  - md2reviewを利用するのに必要
- Node.js
  - anyenv経由でndenvを入れてインストール
  - ReVIEW-Templateを利用するのに必要
- Docker
  - Docker for Macでインストール

### 変換の流れ

変換の流れは以下のとおりです。本ブログはHexoを用いて構築しており、Markdownを拡張してHexoのマクロを利用しているのとHexo独自のYaml Front Matterを取り除いて一般的なMarkdownに自力で変換する必要がありました。それ以外はそれほど難しくないはず・・・とおもっていましたがいろいろとハマリました(泣)。

1. マークダウンからHexoのマクロを取り除く(自前Rubyスクリプト)
2. md2reviewでマークダウンをRe:VIEW形式に変換(.md → .re)
3. Re:VIEW形式をPDFに変換
   - config.ymlに基本設定を書く。catalog.ymlに章構成を書く。
   - あとは`./build-in-docker.sh`を実行してpdfファイルを出力させるだけ
     - Re:VIEW内部では一旦TeXに変換されてPDFとして出力される

### 変換で嵌った点

とりあえずいろいろ嵌った点をメモっておきます。TeXコワイ・・

- 取り消し線が引けない
  - {% elink [ReVIEW Tips] LaTeXで取り消し線を引く - Qiita https://qiita.com/takahashim/items/5c1af2941a1ce9fa5919 %}
- ソース上何も問題ないはずなのに，Text line contains an invalid character. ^^H や Package inputenc Error: Keyboard character used is undefined (inputenc) in inputencoding utf8 というエラーが出てコンパイルできない
  - [TeXShop FAQ - TeX Wiki](https://texwiki.texjp.org/?TeXShop%20FAQ)
  - Macの日本語変換のバグだと・・・　まじかよ・・・
- エラーでTeXの行数が出力された・・・
  - config.ymlでdebugをtrueにすると出力されたTeXが削除されない
- 記法が入れ子になるところで所々エラーになる
  - 例えば太字のなかでURL参照とか
  - どちらかを諦める
- 出力場所(article)配下のpdfやhtmlファイルは次回実行時に問答無用で消される
  - 必要なpdfやhtmlファイルはarticleディレクトリから退避させましょう

### 印刷用原稿の完成

以下が印刷用の原稿の見開きの様子です。上下左右や角に付いているラインは**「トンボ」**と呼ばれていて裁断ラインを表しています[^2]。内側にある小さい数字は**「ノンブル」**といって印刷する全てのページに必要な数字です。これは印刷所が乱丁・落丁の確認に用いるもので必ず裁断ラインの内側に印刷する必要があります。印刷原稿にはこのトンボとノンブルが必要で、更に言えば偶数ページにする必要があったりフォントをPDFに埋め込まなければいけない等、様々な制約があります。

{% img /gallery/daily/others/book_print.png %}

[^2]: トンボはトリムラインとも呼ばれます。

### 表紙、裏表紙の作成

印刷用原稿はできましたが、表紙と裏表紙は原稿とは別に作成します。一般的には表紙と原稿は紙質やカラー/モノクロかの違いがあるのでファイルとしても別になります。
今回は表紙と裏表紙の作成にはMac標準のKeynoteを使いました。といっても適当に取った写真を加工しただけです。

注意すべきはサイズと解像度です。表紙は全面になるので本のサイズより少し大きい**実寸**で作成します。今回はB5なので595.28 x 841.89ポイントになります。ちなみに1ポイント0.3528mmなので覚えておくと便利です。KeynoteはそのままPDF出力ができるので最初にスライドの大きさをポイントで指定してPDFで出力するだけでOKです。以下が完成した表紙です。表紙ができるだけで一気にテンションがあがるので、原稿に詰まったら表紙の作成をすることをおすすめします（笑）。

{% img /gallery/daily/others/hinastory_cover.jpeg 300 %}

## 完成（仮）

なんとか画像や埋め込まれたオブジェクトを抜きにして完成（仮）しました。以下は電子書籍用に出力したPDFファイルです。２章まで公開しました。

{% pdf ../../../..//gallery/daily/others/hinastory_techbook-1-29.pdf %}
　
目次をご覧頂ければ分かりますが300ページを超えています。画像抜きでこのページ数だと紙の本にはしづらいですね。とりあえず分冊を考えます・・・

## まとめ

意外と簡単・・・とはいかなかったですが、すでに先人がいろいろ切り開いてくれていたので挫けずに念願の「本」を作成することができました。そして正直言って一冊の「本」を書くのは漠然と難しいと思っていましたが、蓋を開けてみれば1年間で300ページを超える長編小説並みの文章を生産していました（笑)。

実際に本として読んで見ましたが、**エッセイっぽくて意外といけるな**と思いました。確かに章ごとの繋がりはありませんが、もともとのブログの記事内の節構成はしっかりしていたので意外と本としても違和感なく読めました。また、少なくとも同人誌では章ごとに執筆者が違うことも多々あるので、それと比較すると一冊の本としてはまとまりがあると感じました。

もちろんブログと違うことも多々あって、一番の大きな違いは**リンクやブログカードの扱い**です。電子書籍はそのままリンクが機能しますが紙ではリンク先に飛べないので別途表示方法を考える必要があると感じました。あと画像やオブジェクト（地図や動画やスライド）の埋め込みは今回できなかったのでそれをどのように扱うかは今後の課題です。

本だけではなくて本記事も長くなって来たので、とりあえず書き初めはここまでにして次回は**（仮）**を外して立派な本を出版できるように精進します(笑)。

本記事がMarkdownで電子書籍を作成したい方の一助となれば幸いです。